<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width initial-scale=1">
	<meta name="description" content="Useless math is useful math. It can be used to generate more useless math.
">
	<meta name="author" content="">

	<title>Image Processing with numpy, scipy and matplotlibs in sage</title>

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap theme -->
	<link href="/css/bootstrap-theme.min.css" rel="stylesheet">

	<!-- Custom styles for this template -->
	<link href="/css/blog.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/pygments.css">


	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body role="document">

	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">Francisco Blanco-Silva</a>
		</div>
		<div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				
				
				<li><a class="page-link" href="/about/">About me</a></li>
				
				
				
				<li><a class="page-link" href="/books/">Books</a></li>
				
				
				
				
				
				
				
				
				
				<li><a class="page-link" href="/media.html">In the media</a></li>
				
				
				
				<li><a class="page-link" href="/presentations.html">Presentations</a></li>
				
				
				
				<li><a class="page-link" href="/resume.html">Résumé</a></li>
				
				
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown">Teaching <span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
						<li class="dropdown-header">Current | Most recent classes</li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/08/19/ma141-fall-2014.html">MA141—Fall 2014</a></li>
						
						
						
						<li><a href="/course/2014/08/18/math-122-fall-2014.html">MA122—Fall 2014</a></li>
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/01/11/ma-241-spring-2014.html">MA241—Spring 2014</a></li>
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2013/08/22/ma242-fall-2013.html">MA242—Fall 2013</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2012/06/26/ma142-summer-ii-2012.html">MA142—Summer II 2012</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li class="divider"></li>
						<li class="dropdown-header">Selected Class Material</li>
						
						
						<li><a href="/teaching/2014/11/08/past-classes.html">Past Sections of Undergraduate Calculus</a></li>
						
						
						
						<li><a href="/teaching/2014/11/08/Mathematical-Imaging.html">Mathematical Imaging</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/10/27/an-introduction-to-algebraic-topology.html">An Introduction to Algebraic Topology</a></li>
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/07/08/ma598r.html">MA598R—Summer 2007</a></li>
						
						
						
						
						
						
						
						
<!-- 						<li>Introduction to the Theory of Distributions</li>
						<li>The Basic Practice of Statistics</li> -->
					</ul>
				</li>
			</ul>
		</div><!--/.nav-collapse -->
	</div>
</nav>



	<div class="page-content">
		<div class="wrapper">
			<br />
<br />
<br />
<br />
<div class="container theme-showcase" role="main" style="font-size:16px; font-family: Helvetica; width:750px; text-align:justify;">

	<header class="post-header">
		<h1 class="post-title">Image Processing with numpy, scipy and matplotlibs in sage</h1>
		<p class="post-meta">Dec 15, 2010</p>
	</header>

	<article class="post-content">
		<p>In this post, I would like to show how to use  a few different features of <code>numpy</code>, <code>scipy</code> and <code>matplotlibs</code> to accomplish a few basic image processing tasks: some trivial image manipulation, segmentation, obtaining of structural information, etc.  An excellent way to show a good set of these techniques is by working through a complex project.  In this case, I have chosen the following:</p>

<blockquote>
  <p>Given a HAADF-STEM micrograph of a bronze-type Niobium Tungsten oxide <span>\( Nb_4W<em>{13}O</em>{47} \)</span> (left), find a script that constructs a good approximation to its structural model (right).</p>

</blockquote>

<table style="width:80%;margin-left:auto;margin-right:auto;background-color:#f4f5f7;border-width:0;">
<tbody>
<tr>
<td style="width:50%;border-width:0;"><img src="http://farm6.static.flickr.com/5204/5263737266_726e39eaf3_o_d.jpg" alt="" width="250" height="250" /></td>
<td style="width:50%;border-width:0;"><img src="http://farm6.static.flickr.com/5126/5263737296_03f9eb0224_o_d.jpg" alt="" width="250" height="250" /></td>
</tr>
<tr>
<td style="text-align:center;border-width:0;" colspan="2">Courtesy of <a href="//www.microscopy.ethz.ch/BFDF-STEM.htm">ETH Zurich</a></td>
</tr>
</tbody>
</table>

<p>For pedagogical purposes, I took the following approach to solving this problem:</p>

<ol>
  <li><strong>Segmentation of the atoms</strong> by thresholding and morphological operations.</li>
  <li><strong>Connected component labeling</strong> to extract each single atom for posterior examination.</li>
  <li><strong>Computation of the centers of mass</strong> of each label identified as an atom.  This presents us with a lattice of points in the plane that shows a first insight in the structural model of the oxide.</li>
  <li>Computation of <strong>Delaunay triangulation</strong> and <strong>Voronoi diagram</strong> of the previous lattice of points.  The combination of information from these two graphs will lead us to a decent (approximation to the actual)  structural model of our sample.</li>
</ol>

<p>Let us proceed in this direction:</p>

<h4 id="needed-libraries-and-packages">Needed libraries and packages</h4>

<p>Once retrieved, our HAADF-STEM images will be stored as big matrices with <code>float32</code> precission.  We will be doing some heavy computations on them, so it makes sense to use the <code>numpy</code> and <code>scipy</code> libraries.  From the first module we will retrieve all the functions; from the second, it is enough to retrieve the tools in the <code>scipy.ndimage</code> package (multi-dimensional image processing).  The procedures that load those images into matrices, as well as some really good tools to manipulate plots and present them are in the <code>matplotlib</code> libraries; more concretely, <code>matplotlib.image</code> and <code>matplotlib.pyplot</code>.  We will use them too.  The preamble then looks like this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno">2</span> <span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="lineno">3</span> <span class="kn">import</span> <span class="nn">matplotlib.image</span>
<span class="lineno">4</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span></code></pre></div>

<h4 id="loading-the-image">Loading the image</h4>

<p>The image is loaded with the command <code>matplotlib.imread(filename)</code>.  It stores the image as a <code>numpy.ndarray</code> with <code>dtype=float32</code>.  Notice that the maxima and minima are respectively <code>1.0</code> and <code>0.0</code>.  Other interesting information about the image can be retrieved:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">img</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&#39;/Users/blanco/Desktop/NbW-STEM.png&#39;</span><span class="p">)</span>
<span class="lineno">2</span> 
<span class="lineno">3</span> <span class="k">print</span> <span class="s">&quot;Image dtype: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="lineno">4</span> <span class="k">print</span> <span class="s">&quot;Image size: </span><span class="si">%6d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="lineno">5</span> <span class="k">print</span> <span class="s">&quot;Image shape: </span><span class="si">%3d</span><span class="s">x</span><span class="si">%3d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="lineno">6</span> <span class="k">print</span> <span class="s">&quot;Max value </span><span class="si">%1.2f</span><span class="s"> at pixel </span><span class="si">%6d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">img</span><span class="o">.</span><span class="n">argmax</span><span class="p">())</span>
<span class="lineno">7</span> <span class="k">print</span> <span class="s">&quot;Min value </span><span class="si">%1.2f</span><span class="s"> at pixel </span><span class="si">%6d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">img</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span>
<span class="lineno">8</span> <span class="k">print</span> <span class="s">&quot;Variance: </span><span class="si">%1.5f</span><span class="se">\n</span><span class="s">Standard deviation: </span><span class="si">%1.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="n">img</span><span class="o">.</span><span class="n">std</span><span class="p">())</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">Image dtype: float32
Image size:  87025
Image shape: 295x295
Max value 1.00 at pixel  75440
Min value 0.00 at pixel   5703
Variance: 0.02580
Standard deviation: 0.16062</code></pre></div>

<p>Thresholding is done, as in <code>matlab</code>, by imposing an inequality on the matrix holding the data.  The output is a <code>True-False</code> matrix of ones and zeros, where a one (white) indicates that the inequality is fulfilled, and zero (black) otherwise.</p>

<table style="width:100%;border-width:0;">
<tbody>
<tr>
<td style="width:50%;border-width:0;"><img src="http://farm6.static.flickr.com/5007/5263446911_4d0a9b95e0_o_d.png" alt="" width="100%" /></td>
<td style="width:50%;border-width:0;"><img src="http://farm6.static.flickr.com/5081/5264059122_ebd6a55259_o_d.png" alt="" width="100%" /></td>
</tr>
<tr>
<td style="width:50%;text-align:center;border-width:0;"><code>img &gt; 0.2</code></td>
<td style="width:50%;text-align:center;border-width:0;"><code>img &gt; 0.7</code></td>
</tr>
<tr>
<td style="width:50%;border-width:0;"><img src="http://farm6.static.flickr.com/5046/5263447021_b1cbff99a5_o_d.png" alt="" width="100%" /></td>
<td style="width:50%;border-width:0;"><img src="http://farm6.static.flickr.com/5203/5264059274_2ec7849e8d_o_d.png" alt="" width="100%" /></td>
</tr>
<tr>
<td style="width:50%;text-align:center;border-width:0;"><code>multiply(img &lt; 0.5,img &gt; 0.25)</code></td>
<td style="width:50%;text-align:center;border-width:0;"><code>multiply(img, img &gt; 0.62)</code></td>
</tr>
</tbody>
</table>

<p>By visual inspection of several different thresholds, I chose <code>0.62</code> as one that gives me a good map showing what I need for segmentation.  I need to get rid of “outliers”, though: small particles that might fulfill the given threshold, but are small enough not to be considered an actual atom.  Therefore, in the next step I perform a morphological operation of opening to get rid of those small particles: I decided than anything smaller than a quare of size <span>\( 2 \times 2 \)</span> is to be eliminated from the output of thresholding:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">BWatoms</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span>  <span class="o">&gt;</span>  <span class="mf">0.62</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">BWatoms</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">binary_opening</span><span class="p">(</span><span class="n">BWatoms</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span></code></pre></div>

<p>And we are now ready for segmentation.  We perform this task with the <code>scipy.ndimage.label</code> function:  It collects one slice per segmented atom, and the number of slices computed.  We need to indicate what kind of connectivity is allowed.  For example, in the toy example below, do we consider this as one or two atoms?</p>

<p style="text-align:center;"><img src="http://farm6.static.flickr.com/5088/5264416962_2f1aed00b0_o_d.jpg" alt="" /></p>

<p>It all depends: I’d rather have it now as two different connected components, but for some other problems I might consider that they are just one.  The way we code it, is by imposing a structuring element that defines feature connections.  For example, if our criteria for connectivity between two pixels is that they are in adjacent edges, then the structuring element looks like the image in the left below.  If our criteria for connectivity between two pixels is that they are also allowed to share a corner, then the structuring element looks like the image in the right below.  For each pixel we impose the chosen structuring element, and count the intersection: if there are no intersections, then the two pixels are not connected.  Otherwise, they belong to the same connected component.</p>

<p style="text-align:center;"><img src="http://farm6.static.flickr.com/5203/5263858489_fb5f537793_o_d.jpg" alt="" /></p>

<p>I want to make sure that atoms that are too close in a diagonal direction are counted as two, rather than one, so I chose the structuring element on the left.  The script reads then as follows:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">structuring_element</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
<span class="lineno">2</span> <span class="n">segmentation</span><span class="p">,</span> <span class="n">segments</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">BWatoms</span><span class="p">,</span> <span class="n">structuring_element</span><span class="p">)</span></code></pre></div>

<h4 id="generation-of-the-lattice-of-the-oxide">Generation of the lattice of the oxide</h4>

<p>The object <code>segmentation</code> contains a list of slices, each of them with a <code>True-False</code> matrix containing each of the found atoms of the oxide.  We can obtain for each slice a great deal of useful information.  For example, the coordinates of the centers of mass of each atom can be retrieved by</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">segments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="lineno">2</span> <span class="n">xcoords</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">])</span>
<span class="lineno">3</span> <span class="n">ycoords</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">])</span></code></pre></div>

<p>Note that, because of the way matrices are stored in memory, there is a trasposition of the <span>\( x \)</span> and <span>\( y \)</span>-coordinates of the locations of the pixels.  No big deal, but we need to take it into account.</p>

<p>Other useful bits of information available:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="c">#Calculate the minima and maxima of the values of an array</span>
<span class="lineno"> 2</span> <span class="c">#at labels, along with their positions.</span>
<span class="lineno"> 3</span> <span class="n">allExtrema</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">extrema</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">segments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="lineno"> 4</span> <span class="n">allminima</span> <span class="o">=</span> <span class="n">allExtrema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno"> 5</span> <span class="n">allmaxima</span> <span class="o">=</span> <span class="n">allExtrema</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno"> 6</span> <span class="n">allminimaLocations</span> <span class="o">=</span> <span class="n">allExtrema</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="lineno"> 7</span> <span class="n">allmaximaLocations</span> <span class="o">=</span> <span class="n">allExtrema</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># Calculate the mean of the values of an array at labels.</span>
<span class="lineno">10</span> <span class="n">allMeans</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">means</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">segments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span></code></pre></div>

<p>Notice the overlap of the computed lattice of points over the original image (below, left): we have successfully found the centers of mass of <em>most</em> atoms, although there are still about a dozen regions where we are not too satisfied with the result.  It is time to fine-tune by the simple method of changing the values of some variables: play with the threshold, with the structuring element, with different morphological operations, etc.  We can even add all the obtained information for a wide range of those variables, and filter out outliers.  An example with optimized segmentation is shown below (right):</p>

<table style="width:100%;border-width:0;">
<tbody>
<tr>
<td style="width:50%;border-width:0;padding:0;"><img src="http://farm6.static.flickr.com/5169/5265060098_8ba3938f82_o_d.png" alt="" width="100%" /></td>
<td style="width:50%;border-width:0;padding:0;"><img src="http://farm6.static.flickr.com/5082/5267637261_3cdd7a3cb5_o_d.png" alt="" width="100%" /></td>
</tr>
</tbody>
</table>

<h4 id="structural-model-of-the-sample">Structural Model of the sample</h4>

<p>For the purposes of this post, we will be happy providing the Voronoi diagram and Delaunay triangulation of the previous lattice of points.  With <code>matplotlib</code> we can take care of the latter with a simple command:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">triang</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">Triangulation</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span><span class="n">ycoords</span><span class="p">)</span></code></pre></div>

<p>To show the results, I overlaid the original image (with a forced gray colormap) with the triangulation generated above (in blue).</p>

<p style="text-align:center;"><img src="http://farm6.static.flickr.com/5049/5266467754_45b80afc0b_o_d.png" alt="" width="50%" /></p>

<p>The next step is the computation of the Voronoi diagram.  I generated one by <em>brute force</em>: the function <code>scipy.ndimage.distance_transform_edt</code> provides us with an exact euclidean distance transform for any segmentation.  Once this transform is computed, I assigned to each pixel the value of the nearest segment.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">segmentation</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_distances</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">return_indices</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">voronoi</span> <span class="o">=</span> <span class="n">segmentation</span><span class="p">[</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">]</span></code></pre></div>

<p>Note that, since there are so many atoms (about 1600), the array stored in <code>voronoi</code> will have those many different colors.  A raw visualization of that array will give us little insight on the structural model of the sample (below, left).  Instead, we want to reduce the number of “colors”, so that visualization is meaningful.  I chose 64 different colors, and used an appropriate colormap for this task (below, center).  Another possibility is, of course, to plot the edges of the Voronoi map (not to confuse it with the actual Voronoi diagram!): We can compute these with the simple command</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">imfilter</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="s">&#39;find_edges&#39;</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">edges</span>  <span class="o">&gt;</span>  <span class="mi">0</span><span class="p">)</span></code></pre></div>

<p>In the image below (right) I have included the lattice with the edges of the Voronoi diagram.</p>

<table style="width:100%;border-width:0;">
<tbody>
<tr>
<td style="width:33%;border-width:0;padding:0;"><img src="http://farm6.static.flickr.com/5085/5267590465_3c45e33766_o_d.png" alt="" width="100%" /></td>
<td style="width:33%;border-width:0;padding:0;"><img src="http://farm6.static.flickr.com/5168/5268169666_0ee39a0ed1_o_d.png" alt="" width="100%" /></td>
<td style="width:33%;border-width:0;padding:0;"><img src="http://farm6.static.flickr.com/5121/5267649963_8c293f6011_o_d.png" alt="" width="100%" /></td>
</tr>
</tbody>
</table>

<p>But the structural model will not be complete unless we include the information of the chambers of the sample, as well as that of the atoms.  The reader will surely have no trouble modifying the steps above to accomplish that task.  The combination of the information obtained by merging both Voronoi diagrams accordingly, will yield an accurate model for the sample at hand.  More importantly, this procedure can be applied to any micrograph of similar appearance.  Note that the quality and resolution of the acquired images will surely enforce different optimal values on thresholds, and fine-tuning of the other variables.  But we can expect a decent result nonetheless.   Even better outcomes are to be expected when we employ more serious techniques: the segmentation based on thresholding and morphology is weak compared to watershed techniques, or segmentations based on PDEs.  <a href="http://blancosilva.wordpress.com/teaching/mathematical-imaging/edge-detection/">Better edge-detection filters</a> are also available.</p>

<p>All the computational tools are amazingly fast and, more importantly, freely available.  This was simply unthinkable several years ago.</p>

<h4 id="generation-of-figures">Generation of figures</h4>

<p>One example will suffice.  For instance, the commands used to save to <code>png</code> format the last image are given by:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="lineno">2</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
<span class="lineno">3</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">triang</span><span class="p">,</span> <span class="s">&#39;r.&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="lineno">4</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">gray</span><span class="p">()</span>
<span class="lineno">5</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
<span class="lineno">6</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;/Users/blanco/Desktop/output.png&#39;</span><span class="p">)</span></code></pre></div>


	</article>

	
	<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'eseprimo'; // required: replace example with your forum shortname
        
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
        	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        	dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
	
</div>


<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

		</div>
	</div>

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56262970-1', 'auto');
  ga('send', 'pageview');

</script>
	<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=10117038; 
var sc_invisible=1; 
var sc_security="1fd852f3"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="free hit
counters" href="http://statcounter.com/"
target="_blank"><img class="statcounter"
src="http://c.statcounter.com/10117038/0/1fd852f3/1/"
alt="free hit counters"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->

	    <!-- Bootstrap core JavaScript
	    ================================================== -->
	    <!-- Placed at the end of the document so the pages load faster -->
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	    <script src="/js/bootstrap.min.js"></script>
	    <script src="/assets/js/docs.min.js"></script>
	    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
	    <script src="/assets/js/ie10-viewport-bug-workaround.js"></script>
	    <script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'eseprimo'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    	var s = document.createElement('script'); s.async = true;
    	s.type = 'text/javascript';
    	s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    	(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    
</body>
</html>
