<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width initial-scale=1">
	<meta name="description" content="Useless math is useful math. It can be used to generate more useless math.
">
	<meta name="author" content="">

	<title>Convolution with Gaussian kernels</title>

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.css" rel="stylesheet">
	<!-- Bootstrap theme -->
	<link href="/css/bootstrap-theme.css" rel="stylesheet">

	<!-- Custom styles for this template -->
	<link href="/css/blog.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/pygments.css">
</head>

<body role="document">

	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<a class="navbar-brand" href="#">
				<img alt="Brand" src="https://farm6.staticflickr.com/5131/5393012839_cf3ccae561_o_d.png" style="width:25px;">
			</a>
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
			</button>
			<a class="navbar-brand" href="/">Francisco Blanco-Silva</a>
		</div>
		<div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				
				
				<li><a class="page-link" href="/about/">About me</a></li>
				
				
				
				<li><a class="page-link" href="/books/">Books</a></li>
				
				
				
				
				
				
				
				
				
				
				
				<li><a class="page-link" href="/presentations.html">Presentations</a></li>
				
				
				
				
				
				
				<li class="dropdown">
					<a href="/" class="dropdown-toggle" data-toggle="dropdown">Teaching <span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
						<li class="dropdown-header">Current | Most recent classes</li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/08/19/ma141-fall-2014.html">MA141—Fall 2014</a></li>
						
						
						
						<li><a href="/course/2014/08/18/math-122-fall-2014.html">MA122—Fall 2014</a></li>
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/01/11/ma-241-spring-2014.html">MA241—Spring 2014</a></li>
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2013/08/22/ma242-fall-2013.html">MA242—Fall 2013</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2012/06/26/ma142-summer-ii-2012.html">MA142—Summer II 2012</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li class="divider"></li>
						<li class="dropdown-header">Review Exams</li>
						
						
						<li><a href="/forum/2014/12/02/MA122Fa14RT1.html">MATH 122 Fall 2014 Review Exam (1|4)</a></li>
						
						
						
						<li><a href="/forum/2014/12/02/MA122Fa14RT3.html">MATH 122 Fall 2014 Review Exam (3|4)</a></li>
						
						
						
						<li><a href="/forum/2014/12/02/MA122Fa14RT4.html">MATH 122 Fall 2014 Review Exam (4|4)</a></li>
						
						
						
						<li><a href="/forum/2014/12/02/MA141Fa14RT1.html">MATH 141 Fall 2014 Review Exam (1|5)</a></li>
						
						
						
						<li><a href="/forum/2014/12/02/MA141Fa14RT2.html">MATH 141 Fall 2014 Review Exam (2|5)</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li class="divider"></li>
						<li class="dropdown-header">Selected Class Material</li>
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2014/11/08/past-classes.html">Past Sections of Undergraduate Calculus</a></li>
						
						
						
						<li><a href="/teaching/2014/11/08/Mathematical-Imaging.html">Mathematical Imaging</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/10/27/an-introduction-to-algebraic-topology.html">An Introduction to Algebraic Topology</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/09/24/distributions.html">Introduction to the Theory of Distributions</a></li>
						
						
						
						
						
						<li><a href="/teaching/2010/07/08/ma598r.html">MA598R—Summer 2007</a></li>
						
						
						
						
						
						
						
						
					</ul>
				</li> <!-- dropdown -->
			</ul>
		</div><!--/.nav-collapse -->
	</div>
</nav>



	<div class="page-content">
		<div class="wrapper">
			<br />
<br />
<br />
<br />

<div class="container theme-showcase" role="main" style="font-size: 16px; base-line-height: 1.5; font-family: Helvetica, Arial, sans-serif; spacing-unit: 30px; line-height: 20px; width:750px; text-align:justify;">

	
<!-- 	<header class="post-header">
		<h1 class="post-title">Convolution with Gaussian kernels</h1>
	</header> -->

	<article class="post-content">
		<p>Recall the definition of <a href="http://blancosilva.wordpress.com/teaching/distributions/convolution-of-integrable-functions/">convolution of integrable functions</a>.  In the case of <em>good enough</em> functions in real spaces, one is able to perform this operation by passing to the Fourier domain, multiplying, and coming back through the inverse Fourier transform.   In the setting of digital signals one can also profit from this principle, but by using instead the <em>discrete and inverse discrete Fourier transforms</em>.  With the aid of the <code>fft</code> algorithms to calculate the discrete Fourier transform, convolution via the frequency domain can be faster than directly convolving the time domain signals (<code>scipy.ndimage.convolve</code> in <code>sage</code>), and the final result is the same except maybe at the borders of the image.  Some care must be taken when producing the convolution this way, since zero-padding needs to be applied.</p>

<p>The following example shows several ways to proceed, and offers some intuition on how these approaches differ to each other:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">image</span> <span class="o">=</span> <span class="n">float32</span><span class="p">(</span><span class="n">random_matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="lineno"> 6</span> <span class="n">kern</span> <span class="o">=</span> <span class="n">float32</span><span class="p">(</span><span class="n">random_matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="n">result1</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">kern</span><span class="p">)</span>
<span class="lineno"> 9</span> <span class="n">result2</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="n">multiply</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">kern</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="p">)</span>
<span class="lineno">10</span> <span class="n">result3</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">kern</span><span class="p">)</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="n">l</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">kern</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">kern</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="n">result4</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="n">multiply</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">image</span><span class="p">,[</span><span class="n">l</span><span class="p">,</span><span class="n">w</span><span class="p">]),</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">kern</span><span class="p">,[</span><span class="n">l</span><span class="p">,</span><span class="n">w</span><span class="p">]))</span> <span class="p">)</span></code></pre></div>

<table style="margin-left:auto;margin-right:auto;width:75%;">
<tbody>
<tr>
<td style="width:50%;"><img src="https://i0.wp.com/farm6.static.flickr.com/5208/5369149286_9a995c1856_o_d.jpg" alt="" width="100%" /></td>
<td style="width:50%;"><img src="https://i0.wp.com/farm6.static.flickr.com/5087/5369149338_7346296bf0_o_d.jpg" alt="" width="100%" /></td>
</tr>
<tr>
<td style="width:50%;text-align:center;">`result1`</td>
<td style="width:50%;text-align:center;">`real(result2)`</td>
</tr>
<tr>
<td style="width:50%;"><img src="https://i0.wp.com/farm6.static.flickr.com/5005/5368539629_9968266318_o_d.jpg" alt="" width="100%" /></td>
<td style="width:50%;"><img src="https://i0.wp.com/farm6.static.flickr.com/5005/5368539629_9968266318_o_d.jpg" alt="" width="100%" /></td>
</tr>
<tr>
<td style="width:50%;text-align:center;">`real(result3[1:7,1:7])`</td>
<td style="width:50%;text-align:center;">`real(result4[1:7,1:7])`</td>
</tr>
</tbody>
</table>

<p><strong>[Note:</strong> Both <code>result1</code> and <code>result2</code> are matrices with size <span>\( 6\times 6, \)</span> while the matrices <code>result3</code> and <code>result4</code>, which are identical, have size <span>\( 8\times 8. \)</span><strong>]</strong></p>

<p>Another word of advise: one might feel tempted to create a Gaussian of the same size and shape of the original image.  For example, if the original image has size <span>\( 512 \times 512, \)</span> to create the Gaussian <span>\( G_{16} \)</span> one could proceed in <code>sage</code> as follows:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">scipy</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="c"># Create a 512x512 radial matrix</span>
<span class="lineno"> 5</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">]</span> <span class="o">=</span> <span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="mi">256</span><span class="p">:</span><span class="mi">256</span><span class="p">,</span> <span class="o">-</span><span class="mi">256</span><span class="p">:</span><span class="mi">256</span><span class="p">]</span>
<span class="lineno"> 6</span> <span class="n">A</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">Y</span>
<span class="lineno"> 7</span> <span class="n">R</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># Create a full(!?) 512x512 gaussian kernel Gt</span>
<span class="lineno">10</span> <span class="n">t</span> <span class="o">=</span> <span class="mf">16.0</span>
<span class="lineno">11</span> <span class="n">Gt</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">multiply</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="o">/</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="mf">4.0</span><span class="o">/</span><span class="n">pi</span><span class="o">/</span><span class="n">t</span>
<span class="lineno">12</span> <span class="n">Gt</span> <span class="o">=</span> <span class="n">float32</span><span class="p">(</span><span class="n">Gt</span><span class="p">)</span></code></pre></div>

<p>The procedure of convolution of a noisy version of an image with this kernel could be done as follows:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="c"># Consider the lena image</span>
<span class="lineno"> 2</span> <span class="n">image</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">lena</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float32</span><span class="p">)</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="c"># Add some white Gaussian noise mu=0 sigma=16</span>
<span class="lineno"> 5</span> <span class="n">NoisyImage</span> <span class="o">=</span> <span class="n">image</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="lineno"> 6</span> <span class="n">NoisyImageBase</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span> <span class="n">NoisyImage</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">,</span> <span class="n">NoisyImage</span><span class="o">&lt;=</span><span class="mi">255</span> <span class="p">)</span>
<span class="lineno"> 7</span> <span class="n">NoisyImage</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span> <span class="n">NoisyImage</span><span class="p">,</span> <span class="n">NoisyImageBase</span><span class="p">)</span> <span class="o">+</span> <span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">NoisyImage</span><span class="o">&gt;</span><span class="mf">255.0</span><span class="p">)</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># Compute the convolution of lena with Gt.</span>
<span class="lineno">10</span> <span class="n">convImageGt</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">NoisyImage</span><span class="p">,</span> <span class="n">Gt</span><span class="p">)</span></code></pre></div>

<table style="width:75%;margin-left:auto;margin-right:auto;">
<tbody>
<tr>
<td style="width:33%;"><img src="https://i0.wp.com/farm6.static.flickr.com/5042/5366863591_3b00e8f053_o_d.png" alt="" width="100%" /></td>
<td style="width:33%;"><img src="https://i0.wp.com/farm6.static.flickr.com/5164/5367475002_4275491e81_o_d.png" alt="" width="100%" /></td>
<td style="width:33%;"><img src="https://i0.wp.com/farm6.static.flickr.com/5083/5367860350_722fcc41a8_o_d.png" alt="" width="100%" /></td>
</tr>
<tr>
<td style="width:33%;text-align:center;">`original: image`</td>
<td style="width:33%;text-align:center;">`image + noise`</td>
<td style="width:33%;text-align:center;">`convImageGt`</td>
</tr>
</tbody>
</table>

<p>Granted:  It accomplishes the requested operation, but at the expense of too many computations and storing unnecessary data—especially in cases where the original image contains millions of pixels!</p>

<p>Note the structure of the Gaussian kernel <span>\( G_{1} \)</span> (below, left).  This function is effectively zero more than about three standard deviations from the mean, so it does not make sense to store more than a small center window (below, right).  We therefore collect the important values in a small matrix and use it as a kernel instead, at the time of computing the convolution.</p>

<p style="text-align:center;"><img src="https://i0.wp.com/farm6.static.flickr.com/5005/5367837394_f3c2d026fe_o_d.png" alt="" width="300px" /></p>

<div>
\begin{equation}
 \texttt{Gt} = \dfrac{1}{273} \begin{pmatrix} 1&amp;4&amp;7&amp;4&amp;1\\ 4&amp;16&amp;26&amp;16&amp;4\\ 7&amp;26&amp;41&amp;26&amp;7\\ 4&amp;16&amp;26&amp;16&amp;4\\ 1&amp;4&amp;7&amp;4&amp;1 \end{pmatrix}
 \end{equation}
</div>

	</article>

	
	<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'blancosilva'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

	

</div>

<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

		</div>
	</div>

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56262970-1', 'auto');
  ga('send', 'pageview');

</script>
	<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=10117038; 
var sc_invisible=1; 
var sc_security="1fd852f3"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="free hit
counters" href="http://statcounter.com/"
target="_blank"><img class="statcounter"
src="http://c.statcounter.com/10117038/0/1fd852f3/1/"
alt="free hit counters"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
</body>
</html>
