<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width initial-scale=1">
	<meta name="description" content="Useless math is useful math. It can be used to generate more useless math.
">
	<meta name="author" content="">

	<title>Denoising: wavelet thresholding</title>

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.css" rel="stylesheet">
	<!-- Bootstrap theme -->
	<link href="/css/bootstrap-theme.css" rel="stylesheet">

	<!-- Custom styles for this template -->
	<link href="/css/blog.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/pygments.css">
</head>

<body role="document">

	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<a class="navbar-brand" href="#">
				<img alt="Brand" src="https://farm6.staticflickr.com/5131/5393012839_cf3ccae561_o_d.png" style="width:25px;">
			</a>
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
			</button>
			<a class="navbar-brand" href="/">Francisco Blanco-Silva</a>
		</div>
		<div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				
				
				<li><a class="page-link" href="/about/">About me</a></li>
				
				
				
				<li><a class="page-link" href="/books/">Books</a></li>
				
				
				
				
				
				
				
				
				
				
				
				<li><a class="page-link" href="/presentations.html">Presentations</a></li>
				
				
				
				
				
				
			</ul> <!-- nav navbar-nav -->
			<ul class="nav navbar-nav navbar-right">
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown">Teaching <span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
						<li class="dropdown-header">Current | Most recent classes</li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/08/19/ma141-fall-2014.html">MA141—Fall 2014</a></li>
						
						
						
						<li><a href="/course/2014/08/18/math-122-fall-2014.html">MA122—Fall 2014</a></li>
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/01/11/ma-241-spring-2014.html">MA241—Spring 2014</a></li>
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2013/08/22/ma242-fall-2013.html">MA242—Fall 2013</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2012/06/26/ma142-summer-ii-2012.html">MA142—Summer II 2012</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li class="divider"></li>
						<li class="dropdown-header">Selected Class Material</li>
						
						
						<li><a href="/teaching/2014/11/08/past-classes.html">Past Sections of Undergraduate Calculus</a></li>
						
						
						
						<li><a href="/teaching/2014/11/08/Mathematical-Imaging.html">Mathematical Imaging</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/10/27/an-introduction-to-algebraic-topology.html">An Introduction to Algebraic Topology</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/09/24/distributions.html">Introduction to the Theory of Distributions</a></li>
						
						
						
						
						
						<li><a href="/teaching/2010/07/08/ma598r.html">MA598R—Summer 2007</a></li>
						
						
						
						
						
						
						
						
					</ul>
				</li> <!-- dropdown -->
			</ul>
		</div><!--/.nav-collapse -->
	</div>
</nav>



	<div class="page-content">
		<div class="wrapper">
			<br />
<br />
<br />
<br />

<div class="container theme-showcase" role="main" style="font-size: 16px; base-line-height: 1.5; font-family: Helvetica, Arial, sans-serif; spacing-unit: 30px; line-height: 20px; width:750px; text-align:justify;">

	
<!-- 	<header class="post-header">
		<h1 class="post-title">Denoising: wavelet thresholding</h1>
	</header> -->

	<article class="post-content">
		<p>We have seen a naïve way to perform denoising on images by a simple <a href="http://blancosilva.github.io/course-material/2011/01/18/convolution-with-gaussian-kernels.html">convolution with Gaussian kernels</a>.  In this post I would like to compare that simple method with a more elaborate one: <em>wavelet thresholding</em>.  The basic philosophy is based upon the local knowledge that wavelet coefficients offer us: Intuitively, small wavelet coefficients are dominated by noise, while wavelet coefficients with a large absolute value carry more signal information than noise.  Being that the case, it is reasonable to obtain a fast denoising of a given image if we perform two basic operations:</p>

<ul>
  <li>Eliminate in the wavelet representation those elements with small coefficients, and</li>
  <li>Decrease the impact of elements with large coefficients.</li>
</ul>

<p>In mathematical terms, all we are doing is <em>thresholding</em> the absolute value of wavelet coefficients by an appropriate function. For example, if we chose to eliminate all coefficients with absolute value less than a given threshold <span>\( \theta \)</span>, and keep the rest of the coefficients untouched, we end up with the thresholding function <span>\( \tau_\theta \colon \mathbb{R}^+ \to \mathbb{R} \)</span> given by:</p>

<p style="text-align:center;"><img src="https://i0.wp.com/farm6.static.flickr.com/5124/5381177149_15bb17a09e_m_d.jpg" style="width:25%" /></p>
<div>
	\begin{equation}
	\tau_\theta (x) = \begin{cases} 0 &amp;\text{if } 0 \leq x\leq \theta \\ x &amp;\text{if } x &gt; \theta\end{cases}
	\end{equation}
</div>

<p>We refer to this function as a <em>hard thresholding</em>.  But we might want to decrease the impact of the elements with large coefficients in absolute value—this is what we refer as <em>soft thresholding</em>.   A common way to perform this thresholding is by simple imposition of continuity of the function; e.g.:</p>

<p style="text-align:center;"><img src="https://i0.wp.com/farm6.static.flickr.com/5047/5381815942_112bef03cf_m_d.jpg" style="width:25%" /></p>
<div>
	\begin{equation}
	\tau_\theta (x) = \begin{cases} 0 &amp;\text{if } 0\leq x\leq \theta \\ x-\theta &amp;\text{if }x &gt; \theta \end{cases} 
	\end{equation}
</div>

<p>Other thresholding functions are of course possible, and the reader is encouraged to come up with different examples, and experiment with them.</p>

<p>The wavelet module <code>PyWavelet</code> is <a href="http://blancosilva.github.io/course-material/2011/01/23/wavelets-in-sage.html">easily embedded in <code>sage</code></a>, and allows us to perform very fast and elegant denoising codes.  The following session shows an example: We load the image of Lena as an array of size <span>\( 512 \times 512 \)</span> containing values between <code>0</code> and <code>255</code>.   We contaminate the image with white noise <span>\( (\sigma=16.0) \)</span> and perform denoising with this technique.  Since <span>\( 512 = 2^9, \)</span> we require all nine levels of the Haar wavelet coefficients of the image.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">scipy</span>
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">pywt</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">image</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">lena</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">float32</span><span class="p">)</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="n">noiseSigma</span> <span class="o">=</span> <span class="mf">16.0</span>
<span class="lineno"> 8</span> <span class="n">image</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noiseSigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="n">wavelet</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">Wavelet</span><span class="p">(</span><span class="s">&#39;haar&#39;</span><span class="p">)</span>
<span class="lineno">11</span> <span class="n">levels</span>  <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span> <span class="n">floor</span><span class="p">(</span> <span class="n">log2</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">)</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="n">WaveletCoeffs</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">wavedec2</span><span class="p">(</span> <span class="n">image</span><span class="p">,</span> <span class="n">wavelet</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span></code></pre></div>

<p>The object <code>WaveletCoeffs</code> is a tuple with ten entries: the first one is the approximation at the highest level: 9; the second entry is a 3-tuple containing the three different details (horizontal, vertical and diagonal) at the same level.  Each consecutive entry is a 3-tuple containing the three different details at lower levels <span>\( (n=8,7,6,5,4,3,2,1) \)</span></p>

<p>The module <code>pywt</code> has several threshold functions implemented.  Let us use the soft thresholding indicated above, with a made-up threshold <span>\( \theta = \sigma \sqrt{2 \log_2(\texttt{image.size})}. \)</span></p>

<p>In order to apply this threshold to each single wavelet coefficient, we will make use of the powerful tools of functional programming from <code>sage</code>.  We need:</p>

<ul>
  <li>A thresholding function.  We use the ones provided by the <code>pywt</code> package: <code>pywt.thresholding.soft</code>, and in particular its lambda expression:</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pywt</span><span class="o">.</span><span class="n">thresholding</span><span class="o">.</span><span class="n">soft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span></code></pre></div>

<ul>
  <li><code>Python</code>’s built-in function <code>map(func, seq1, seq2, ...)</code></li>
  <li>The tuple of objects over which we need to apply the thresholding:  In this case, the set of wavelet coefficients <code>WaveletCoeffs</code> computed above.</li>
</ul>

<p>Once computed the new coefficients, we use <code>pywt.waverec2</code> to obtain the corresponding reconstruction:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">noiseSigma</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">log2</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
<span class="lineno">2</span> <span class="n">NewWaveletCoeffs</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pywt</span><span class="o">.</span><span class="n">thresholding</span><span class="o">.</span><span class="n">soft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">threshold</span><span class="p">),</span> <span class="n">WaveletCoeffs</span><span class="p">)</span>
<span class="lineno">3</span> <span class="n">NewImage</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">waverec2</span><span class="p">(</span> <span class="n">NewWaveletCoeffs</span><span class="p">,</span> <span class="n">wavelet</span><span class="p">)</span></code></pre></div>

<table style="width:75%;border-width:0;margin-left:auto;margin-right:auto;">
<tbody>
<tr>
<td style="width:50%;border-width:0;"><img src="https://i0.wp.com/farm6.static.flickr.com/5164/5367475002_4275491e81_o_d.png" alt="" width="100%" /></td>
<td style="width:50%;border-width:0;"><img src="https://i0.wp.com/farm6.static.flickr.com/5045/5382329870_e3ee536df5_o_d.png" alt="" width="100%" /></td>
</tr>
<tr>
<td style="text-align:center;border-width:0;">original + noise</td>
<td style="text-align:center;border-width:0;">denoised (`haar`)</td>
</tr>
</tbody>
</table>

<p>Denoising is good, but the overall visual quality of the resulting image is very poor: there are many artifacts, due mainly to the blocky nature of the Haar wavelet.  Also, the choice of threshold is artificial: it has a priori no relationship with the structure of the image.  Let’s put a temporary solution to this problem by using a smoother wavelet, while keeping the same threshold.  To avoid excessive typing, we will wrap the code above into a neat function with variables being the image to be treated, the standard deviation of the noise added, and the name of the wavelet employed:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">denoise</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">wavelet</span><span class="p">,</span><span class="n">noiseSigma</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="n">levels</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="lineno">3</span>     <span class="n">WC</span> <span class="o">=</span> <span class="n">pywt</span><span class="o">.</span><span class="n">wavedec2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">wavelet</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>
<span class="lineno">4</span>     <span class="n">threshold</span><span class="o">=</span><span class="n">noiseSigma</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">log2</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
<span class="lineno">5</span>     <span class="n">NWC</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pywt</span><span class="o">.</span><span class="n">thresholding</span><span class="o">.</span><span class="n">soft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">threshold</span><span class="p">),</span> <span class="n">WC</span><span class="p">)</span>
<span class="lineno">6</span>     <span class="k">return</span> <span class="n">pywt</span><span class="o">.</span><span class="n">waverec2</span><span class="p">(</span> <span class="n">NWC</span><span class="p">,</span> <span class="n">wavelet</span><span class="p">)</span></code></pre></div>

<p>We can now perform the same operation with different wavelets.  The following script creates a <code>python</code> dictionary that assigns, to each wavelet, the corresponding denoised version of the corrupted Lena image.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">Denoised</span><span class="o">=</span><span class="p">{}</span>
<span class="lineno">2</span> <span class="k">for</span> <span class="n">wlt</span> <span class="ow">in</span> <span class="n">pywt</span><span class="o">.</span><span class="n">wavelist</span><span class="p">():</span>
<span class="lineno">3</span>     <span class="n">Denoised</span><span class="p">[</span><span class="n">wlt</span><span class="p">]</span> <span class="o">=</span> <span class="n">denoise</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">wavelet</span><span class="o">=</span><span class="n">wlt</span><span class="p">,</span> <span class="n">noiseSigma</span><span class="o">=</span><span class="mf">16.0</span><span class="p">)</span></code></pre></div>

<p>The  four images below are the respective denoising by soft thresholding of wavelet coefficients on the same image with the same level of noise <span>\( (\sigma = 16.0), \)</span> for the symlet <code>sym15</code>, the Daubechies wavelet <code>db6</code>, the biorthogonal wavelet <code>bior2.8</code>, and the coiflet <code>coif2</code>.  Note that, except in the case of the denoising by biorthogonal wavelet, all of the others present clear artifacts:</p>

<table style="width:75%;border-width:0;margin-left:auto;margin-right:auto;">
<tbody>
<tr>
<td style="width:50%;border-width:0;"><img src="https://i0.wp.com/farm6.static.flickr.com/5170/5381872501_e9296eb13c_o_d.png" alt="" width="100%" /></td>
<td style="width:50%;border-width:0;"><img src="https://i0.wp.com/farm6.static.flickr.com/5047/5382434292_891d198cdd_o_d.png" alt="" width="100%" /></td>
</tr>
<tr>
<td style="text-align:center;border-width:0;">denoised (`sym15`)</td>
<td style="text-align:center;border-width:0;">denoised (`db6`)</td>
</tr>
<tr>
<td style="width:50%;border-width:0;"><img src="https://i0.wp.com/farm6.static.flickr.com/5047/5382484863_5a054f4f3f_o_d.png" alt="" width="100%" /></td>
<td style="width:50%;border-width:0;"><img src="https://i0.wp.com/farm6.static.flickr.com/5284/5382485013_0683a07128_o_d.png" alt="" width="100%" /></td>
</tr>
<tr>
<td style="text-align:center;border-width:0;">denoised (`bior2.8`)</td>
<td style="text-align:center;border-width:0;">denoised (`coif2`)</td>
</tr>
</tbody>
</table>

	</article>

	
	<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'blancosilva'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

	

</div>

<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

		</div>
	</div>

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56262970-1', 'auto');
  ga('send', 'pageview');

</script>
	<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=10117038; 
var sc_invisible=1; 
var sc_security="1fd852f3"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="free hit
counters" href="http://statcounter.com/"
target="_blank"><img class="statcounter"
src="http://c.statcounter.com/10117038/0/1fd852f3/1/"
alt="free hit counters"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
</body>
</html>
