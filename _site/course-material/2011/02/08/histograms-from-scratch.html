<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width initial-scale=1">
	<meta name="description" content="Useless math is useful math. It can be used to generate more useless math.
">
	<meta name="author" content="">

	<title>Histograms (from scratch)</title>

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.css" rel="stylesheet">
	<!-- Bootstrap theme -->
	<link href="/css/bootstrap-theme.css" rel="stylesheet">

	<!-- Custom styles for this template -->
	<link href="/css/blog.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/pygments.css">
</head>

<body role="document">

	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<a class="navbar-brand" href="#">
				<img alt="Brand" src="https://farm6.staticflickr.com/5131/5393012839_cf3ccae561_o_d.png" style="width:25px;">
			</a>
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
			</button>
			<a class="navbar-brand" href="/">Francisco Blanco-Silva</a>
		</div>
		<div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				
				
				<li><a class="page-link" href="/about/">About me</a></li>
				
				
				
				<li><a class="page-link" href="/books/">Books</a></li>
				
				
				
				
				
				
				
				
				
				
				
				<li><a class="page-link" href="/presentations.html">Presentations</a></li>
				
				
				
				
				
				
			</ul> <!-- nav navbar-nav -->
			<ul class="nav navbar-nav navbar-right">
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown">Teaching <span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
						<li class="dropdown-header">Current | Most recent classes</li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/08/19/ma141-fall-2014.html">MA141—Fall 2014</a></li>
						
						
						
						<li><a href="/course/2014/08/18/math-122-fall-2014.html">MA122—Fall 2014</a></li>
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2014/01/11/ma-241-spring-2014.html">MA241—Spring 2014</a></li>
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2013/08/22/ma242-fall-2013.html">MA242—Fall 2013</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/course/2012/06/26/ma142-summer-ii-2012.html">MA142—Summer II 2012</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li class="divider"></li>
						<li class="dropdown-header">Selected Class Material</li>
						
						
						<li><a href="/teaching/2014/11/08/past-classes.html">Past Sections of Undergraduate Calculus</a></li>
						
						
						
						<li><a href="/teaching/2014/11/08/Mathematical-Imaging.html">Mathematical Imaging</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/10/27/an-introduction-to-algebraic-topology.html">An Introduction to Algebraic Topology</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/teaching/2010/09/24/distributions.html">Introduction to the Theory of Distributions</a></li>
						
						
						
						
						
						<li><a href="/teaching/2010/07/08/ma598r.html">MA598R—Summer 2007</a></li>
						
						
						
						
						
						
						
						
					</ul>
				</li> <!-- dropdown -->
			</ul>
		</div><!--/.nav-collapse -->
	</div>
</nav>



	<div class="page-content">
		<div class="wrapper">
			<br />
<br />
<br />
<br />

<div class="container theme-showcase" role="main" style="font-size: 16px; base-line-height: 1.5; font-family: Helvetica, Arial, sans-serif; spacing-unit: 30px; line-height: 20px; width:750px; text-align:justify;">

	
<!-- 	<header class="post-header">
		<h1 class="post-title">Histograms (from scratch)</h1>
	</header> -->

	<article class="post-content">
		<p>The purpose of this post is to show how histogram equalization improves the quality of digital images:  After performing this basic procedure, it will look like new gray scales have been brought up.  The truth is that no new gray levels have been introduced: we have simply altered the same gray scales already present in the original, in a way that every value has approximately the same impact.  This gives the illusion of darkening bright images, bringing brightness to dark ones, and discovering hidden texture in a priori flat areas.</p>

<p>Let us build the whole project from the ground up, and in the process, illustrate the notion of histogram, as well as the use of many commands for manipulation of arrays and lists in <code>sage</code>.</p>

<h2 id="computing-the-histogram">Computing the Histogram</h2>

<p>A histogram is nothing but a function that takes as input each of the gray levels present in an image, and offers as output the number of pixels that each of those values share.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">scipy</span>
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">image</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">lena</span><span class="p">()</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="n">Hist</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="lineno"> 8</span> <span class="n">grayscales</span>  <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="n">Hist</span><span class="p">)</span>
<span class="lineno"> 9</span> <span class="n">frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">Hist</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grayscales</span><span class="p">]</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="lineno">12</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">grayscales</span><span class="p">,</span><span class="n">frequencies</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
<span class="lineno">13</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;/Users/blanco/Desktop/histogram.png&#39;</span><span class="p">)</span></code></pre></div>

<table style="width:75%; border:0px; margin-left:auto; margin-right:auto;">
<tr>
<td style="border:0;width:42%;vertical-align:middle;"><img src="https://i0.wp.com/farm6.static.flickr.com/5042/5366863591_3b00e8f053_o_d.png" width="100%" /></td>
<td style="border:0;width:58%;vertical-align:middle;"><img src="https://i0.wp.com/farm6.static.flickr.com/5260/5426847781_48154dbd25_b_d.jpg" width="100%" /> </td>
</tr>
</table>

<p>Of course, there already is a simple (and much faster!) command in <code>sage</code> that will take care of this computation for us: <code>matp</code>.</p>

<h2 id="histogram-equalization">Histogram Equalization</h2>

<p>We alter now the value of each grayscale of the original image, in such a way that the final histogram is as flat as possible, and spreads out over the entire range of the gray levels.  We accomplish this by the following procedure:</p>

<p>Assume <span>\( f \colon \{ 1, \dotsc, N\} \times \{ 1, \dotsc, M\} \to \{ 0, \dotsc, 255\} \)</span> is a <span>\( N \times M \)</span> image with 256 gray-scales.  We are looking for a function <span>\( \mathcal{E}\colon \{ 0, \dotsc, 255\} \to \{ 0, \dotsc, 255\} \)</span> that performs the histogram equalization: <span>\( g(\boldsymbol{x}) = \mathcal{E} \big( f( \boldsymbol{x}) \big) \)</span>.</p>

<p>The way we accomplish it is by:</p>

<ol>
  <li>Collecting first the histogram of each gray-scale <span>\( k \in \{ 0, \dotsc, 255\}: \)</span> <span>\( H(k) = \# \{ \boldsymbol{x} : f(\boldsymbol{x}) = k \} \)</span></li>
  <li>Computing the probability of finding a pixel with each gray-scale in the given image: <span>\( p(k) = \frac{1}{NM} H(k). \)</span></li>
  <li>Computing the cumulative-density function for each gray-scale: 
     \begin{equation} P(k) = \frac{1}{NM} \displaystyle{\sum_{j=0}^k} H(j). \end{equation}</li>
  <li>The histogram equalization <span>\( \mathcal{E} \)</span> simply takes the propability density function for the values in the image <span>\( f \)</span> and multiplies them by the cumulative density function of the values in the image that we seek:</li>
</ol>
<div>
	\begin{equation}
 \mathcal{E}(k) = \frac{1}{NMp(k)} \displaystyle{\sum_{j=0}^k} H(k).
 \end{equation}
</div>

<p>Note that this procedure reduces the number of gray-scales in an image.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">cumsumfreqs</span> <span class="o">=</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
<span class="lineno">2</span> 
<span class="lineno">3</span> <span class="n">histeq</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="lineno">4</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grayscales</span><span class="p">):</span>
<span class="lineno">5</span>     <span class="n">histeq</span><span class="o">+=</span><span class="n">cumsumfreqs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">image</span><span class="o">==</span><span class="n">value</span><span class="p">)</span>
<span class="lineno">6</span> 
<span class="lineno">7</span> <span class="n">histeq</span> <span class="o">/=</span> <span class="n">prod</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="lineno">8</span> <span class="n">histeq</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grayscales</span><span class="p">)</span></code></pre></div>

<table style="width:75%; border:0px; margin-left:auto; margin-right:auto;">
<tr>
<td style="border:0;width:42%;vertical-align:middle;"><img src="https://i0.wp.com/farm6.static.flickr.com/5213/5426920531_0788598a51_o_d.png" width="100%" /></td>
<td style="border:0;width:58%;vertical-align:middle;"><img src="https://i0.wp.com/farm6.static.flickr.com/5092/5427524836_1df4bf472d_b_d.jpg" width="100%" /> </td>
</tr>
</table>

<p>As proof of concept, let us compare original with its histogram-equalized version:</p>

<table style="width:75%; border:0px; margin-left:auto; margin-right:auto;">
<tr>
<td style="border:0;width:50%;vertical-align:middle;"><img src="https://i0.wp.com/farm6.static.flickr.com/5042/5366863591_3b00e8f053_o_d.png" width="100%" /></td>
<td style="border:0;width:50%;vertical-align:middle;"><img src="https://i0.wp.com/farm6.static.flickr.com/5213/5426920531_0788598a51_o_d.png" width="100%" /></td>
</tr>
<td style="border:0;text-align:center;">Original</td>
<td style="border:0;text-align:center;">Histogram-equalization</td>
</table>

<p>Note the obvious sharpening of details, albeit the apparent presence of noise where before the image seemed flat.  This <em>noise</em>—that we can appreciate for example in the hat or walls—actually reveals a richer texture of the materials photographed.  These tectures were not observable directly in the original.  Note as well the accentuation of the brightest areas, producing an image with better contrast.  I am sure the reader will find some more qualitative improvement in the histogram-equalization version of the image.  Working on a set of dark images will reveal even more surprising benefits of this technique.</p>

	</article>

	
	<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'blancosilva'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

	

</div>

<script type="text/javascript"
src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

		</div>
	</div>

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56262970-1', 'auto');
  ga('send', 'pageview');

</script>
	<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=10117038; 
var sc_invisible=1; 
var sc_security="1fd852f3"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="free hit
counters" href="http://statcounter.com/"
target="_blank"><img class="statcounter"
src="http://c.statcounter.com/10117038/0/1fd852f3/1/"
alt="free hit counters"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
</body>
</html>
